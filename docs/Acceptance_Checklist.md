# 验收清单（端到端 / 可截图用于论文）

本文档用于“设备侧 + 云端 + 应用侧”的一步步验收与截图点位记录，便于毕设答辩/论文实验章节复现。

> 安全提示：验收与截图时不要泄露 AK/SK；如必须录屏/截图，请确保页面不会展示明文密钥。

---

## 0. 环境准备

- [ ] 已创建 IoTDA 项目（`project_id`）与设备（`device_id`），并完成设备注册（参考 `docs/HuaweiCloud.MD`）
- [ ] STM32 固件已烧录并能联网（`Aquarium_Device/`，参考 `docs/TECH.MD` 与 `docs/Wiring_Guide.md`）
- [ ] HarmonyOS App 开发环境：DevEco Studio **5.0.5（API 17）**（参考 `Aquarium_APP/README.md`）
- [ ] 设备与手机/模拟器均可访问 IoTDA Endpoint（`Base URL`）

**建议截图**：
- IoTDA 控制台：项目/设备信息页（遮挡敏感信息）

---

## 1. 设备上线（IoTDA 控制台）

**操作**：

- [ ] 打开 IoTDA 控制台 → 设备列表 → 目标设备

**预期**：

- [ ] 设备状态为 `ONLINE`

**建议截图**：

- 设备列表/设备详情页：`ONLINE` 状态截图

---

## 2. 设备上报（影子 / reported）

**操作**：

- [ ] 在 IoTDA 控制台查看设备影子/属性（或观察设备 Topic/消息上报）

**预期**：

- [ ] `reported.properties` 中包含 13 个核心字段（见 `docs/Interface.MD` 的“查询设备影子”示例）

**建议截图**：

- 设备影子/属性页：可见 `temperature/ph/tds/.../alarm_level/alarm_muted` 等字段

---

## 3. App 拉取影子 + 在线/告警展示

**操作**（`Aquarium_APP/`）：

- [ ] 打开 App 首页，填写 `Base URL / Project ID / Device ID`
- [ ] 填写 `AK / SK`（仅用于本机调试，不要写入仓库）
- [ ] 点击“刷新影子/状态”

**预期**：

- [ ] 仪表盘能展示在线状态、告警状态与 13 项属性值
- [ ] “最后刷新时间/结果”更新（失败不覆盖上一次成功时间）

**建议截图**：

- App 仪表盘：13 属性 + 在线/告警 + 最后刷新信息

---

## 4. 下发 `control`（同步命令 /commands）

**操作**：

- [ ] 打开“控制”页，下发任意一项控制（例如 `heater=true` 或“投喂一次 feed=true”）

**预期**：

- [ ] App 显示同步命令回包（`result_code===0` 代表成功）
- [ ] 成功后 App 会自动延迟刷新影子/状态（约 1~2s），仪表盘对应字段变化

**建议截图**：

- 控制页：请求参数 + 成功回包
- 仪表盘：刷新后字段变化（如 `heater` 变更）

---

### 4.1 一次性倒计时投喂（`feed_once_delay`）

**操作**：

- [ ] 在“控制”页填写“一次性倒计时(秒)”，点击“预约一次投喂”

**预期**：

- [ ] 命令回包成功
- [ ] `feed_countdown` 显示为预约倒计时（以影子/导出记录为准）
- [ ] 倒计时结束后 `feeding_in_progress=true`，且完成投喂后自动复位

**建议截图**：

- 控制页：一次性倒计时提交回包
- IoTDA 影子：`feed_countdown` 变化 + `feeding_in_progress` 变化

---

## 5. 下发 `set_thresholds`（异步命令 /async-commands）

**操作**：

- [ ] 打开“阈值&配置”页，填写阈值并点击提交（走 `/async-commands`）

**预期**：

- [ ] 表单范围校验生效：不合法时禁用提交并提示
- [ ] 异步命令返回成功后不等待设备回包；设备后续上报/行为按新阈值生效

**建议截图**：

- 阈值表单：合法输入 + 提交成功提示/回包

---

## 6. 下发 `set_config`（同步命令 /commands）

### 6.1 校准参数（不含 WiFi）

**操作**：

- [ ] 在“阈值&配置”页仅填写校准参数（如 `ph_offset` / `tds_factor`），点击提交

**预期**：

- [ ] 命令回包成功
- [ ] 成功后自动刷新影子/状态

### 6.2 WiFi 变更（含二次确认 + 设备短暂离线）

**操作**：

- [ ] 在“阈值&配置”页填写 `wifi_ssid` + `wifi_password`
- [ ] 点击提交后弹出二次确认（提示“设备会短暂离线重连”）
- [ ] 分别验证“取消/确认”两种路径

**预期**：

- [ ] **若只填 `wifi_password` 未填 `wifi_ssid`**：提示“WiFi 变更需 SSID+PWD 成对提交”，避免误操作
- [ ] 取消：不下发命令
- [ ] 确认：命令回包成功后设备会短暂离线重连；之后恢复 `ONLINE`

**建议截图**：

- 二次确认对话框
- IoTDA 控制台：设备离线/上线过程（或 App 刷新结果变化）

---

### 6.3 严重告警紧急策略（设备侧）

**操作**：

- [ ] 将阈值设置为易触发严重告警（例如温度上限调低）或模拟异常传感器值
- [ ] 触发 `alarm_level=2`

**预期**：

- [ ] 自动模式下进/排水泵被关闭（终止换水）
- [ ] 加热策略进入紧急模式（过热时关闭，其它严重告警时保持加热）

**建议截图**：

- IoTDA 影子：`alarm_level=2` 时 `pump_in=false`、`pump_out=false`

---

## 7. 自动刷新（30s）与历史记录

**操作**：

- [ ] 打开“自动刷新”开关，等待多次刷新（默认 30s/次）
- [ ] 在仪表盘查看历史记录列表（默认显示最近 10 条）
- [ ] 点击“清空历史”

**预期**：

- [ ] 仅在“影子刷新成功”时追加历史；最多保留最近 50 条
- [ ] 清空后列表为空，后续刷新会重新累积

**建议截图**：

- 仪表盘：历史记录列表（含时间戳/在线/告警/传感器值）
- 清空前后对比（可选）

---

## 8. 导出实验记录（JSON / 可复制）

**操作**：

- [ ] 在仪表盘点击“导出实验记录(JSON)”并复制到剪贴板
- [ ] 粘贴到备忘录/文件中检查内容

**预期**：

- [ ] 导出 JSON 包含：当前影子/状态/刷新信息/最近一次命令回包 + `history`
- [ ] **不包含 AK/SK**
- [ ] 如包含 `wifi_password`，必须脱敏为 `***`

**建议截图**：

- 导出成功提示 + 粘贴后的 JSON（遮挡可能包含的敏感信息）

---

## 9. MQTT 实时订阅（Device Endpoint / 1883）

> 可选加分项：用于演示“订阅 MQTT 属性→仪表盘实时更新”。

**操作**：

- [ ] 在首页填写 `Device Secret`（设备密钥，默认不落盘）
- [ ] 打开“实时订阅”开关
- [ ] 观察“实时状态”变为 `CONNECTED`
- [ ] 等待设备下一次属性上报

**预期**：

- [ ] 无需手动刷新，仪表盘属性会更新
- [ ] “最后刷新结果”显示为 `REALTIME`
- [ ] 历史记录会追加 1 条

**建议截图**：

- 首页：实时订阅开关 + 实时状态 `CONNECTED`
- 仪表盘：`REALTIME` + 属性值变化

---

## 10. 趋势图（折线）与宽屏布局

**操作**：

- [ ] 在仪表盘查看“趋势图（最近 N 条）”
- [ ] 切换指标（温度/pH/TDS/浊度/水位）
- [ ] （平板/横屏/宽窗口）观察是否切换为三列并排布局

**预期**：

- [ ] 有 ≥2 条历史数据时显示折线图
- [ ] 指标切换生效
- [ ] 宽屏下仪表盘/控制/阈值&配置并排展示

**建议截图**：

- 趋势图折线（至少 2 条数据）
- 宽屏三列布局（可选）

---

## 11. 告警通知（系统通知）

**操作**：

- [ ] 在首页打开“告警通知（系统通知）”开关
- [ ] 通过下发阈值或等待水质变化触发 `alarm_level` 变化（0→1 或 1→2）

**预期**：

- [ ] `alarm_level` 变化时弹出系统通知 + Toast
- [ ] 关闭开关后不再弹通知

**建议截图**：

- 通知中心/横幅通知：告警标题 + 设备信息

---

## 12. 桌面服务卡片（Widget / Form）

**操作**：

- [ ] 在桌面添加“水族箱”服务卡片（Form）
- [ ] 回到 App 点击“刷新影子/状态”或开启实时订阅触发快照更新
- [ ] 返回桌面观察卡片内容

**预期**：

- [ ] 卡片展示最近一次快照：温度/pH/TDS/浊度/水位/告警等级/更新时间
- [ ] 刷新后卡片更新时间与数值变化（以本机缓存快照为准）

**建议截图**：

- 桌面卡片显示关键指标

---

## 13. 分布式流转与账号同步（加分项）

> 可选加分项：用于演示“多设备配置同步 + 跨设备流转”。

### 13.1 账号同步（分布式KV）

**操作**：

- [ ] 在设备 A 打开 App 首页，开启“分布式同步（同账号/多设备）”
- [ ] 点击“发布到分布式”
- [ ] 在设备 B 打开 App 首页，开启“分布式同步（同账号/多设备）”
- [ ] 点击“从分布式拉取”（或等待自动收到同步更新）

**预期**：

- [ ] 设备 B 自动填充 `Base URL / Project ID / Device ID` 等非敏感配置
- [ ] AK/SK 与 Device Secret 不会被同步

**建议截图**：

- 两台设备页面：同步前后配置对比（遮挡敏感信息）

### 13.2 分布式流转

**操作**：

- [ ] 在设备 A 点击“分布式流转到其他设备”，选择目标设备（设备 B）

**预期**：

- [ ] 设备 B 启动 App，并携带非敏感连接配置参数

**建议截图**：

- 设备选择弹窗 + 设备 B 启动后的首页

---

## 14. 常见问题（快速定位）

- `HTTP 401`：通常是 AK/SK、签名、`Base URL`、`project_id`/`device_id` 填写错误。
- `HTTP 404`：多为 `project_id` / `device_id` 不存在或路径拼写错误。
- `HTTP 408/5xx` 或 “命令超时”：设备离线、网络抖动、或设备正在重连（例如下发 WiFi 配置后短暂离线）。
