一、课题名称  
基于 STM32 与华为云 IoT 的智能水族箱监测与控制系统。

二、项目背景与应用场景  
随着家庭养殖观赏鱼的普及，人们对水族箱的生态平衡提出了更高要求。传统的手工维护方式依赖经验判断，难以及时发现温度、pH、TDS 等指标异常，一旦水质恶化往往导致成批鱼类死亡。本课题聚焦家庭与小型商业场景，通过构建“设备端感知 + 云端协同 + 移动端展示”的闭环方案，实现水环境的实时监测、自动干预与远程运维。系统需适应普通住户的使用习惯，既要提供即插即用的硬件接口，又要整合华为云 IoT 平台以保障数据安全和远程可控，最终达到“无人值守、主动告警、可视化决策”的目标。

三、建设目标  
1. 构建一套稳定可靠的水族箱监测硬件平台，涵盖温度、pH、TDS、浊度、水位等关键传感器，并提供舵机投饵、继电器泵控、声光告警等执行能力。  
2. 实现设备在断电、断网后仍可自动恢复，支持默认 Wi-Fi、用户 Wi-Fi 以及手机热点三种联网方式。  
3. 依托华为云 IoTDA 完成设备注册、属性上报、命令下发和阈值配置，形成可扩展的数据模型。  
4. 开发面向 HarmonyOS 手机/平板的鸿蒙应用（HarmonyOS SDK 5.0.5，API Level 17），采用 ArkTS Stage 模型与卡片化组件，以图表和卡片形式展示实时数据，允许用户远程调整运行模式、投喂计划与水质阈值。  
5. 在毕业设计答辩中展示设备、云、应用三端的协同效果，形成完整的技术文档、需求文档与接线指南，确保后续维护与移植可行。

四、功能需求  
4.1 设备侧功能  
（1）传感器感知：周期性采集水温、pH、TDS、浊度、水位数据，并对采集失败或数值异常进行容错处理；当传感器失效超过阈值时，输出默认安全值并触发告警。  
（2）状态显示：在 OLED 上轮播显示核心指标，提示当前模式、网络状态、告警级别，使用户在本地即可掌握水族箱运行情况。  
（3）自动控制：按照预设阈值自动开停加热棒、进水泵、排水泵，并在检测到严重异常时执行紧急策略（如终止换水、持续加热）。  
（4）投喂管理：支持按固定周期自动投喂，允许用户预约一次性倒计时，并记录当前投喂档位。  
（5）告警机制：根据水质状态触发蜂鸣器与 LED 分级告警，允许用户远程静音，同时将告警等级上报云端。  
（6）网络通信：使用 ESP32 AT 模块建立 MQTT 连接，实现属性上报与命令接收；在默认 Wi-Fi 失败时自动切换到用户配置或 AP 配网模式。  
（7）配置持久化：将用户 Wi-Fi 与传感器校准系数写入 Flash，确保断电重启后仍能加载最新参数。

4.2 云侧功能  
（1）设备管理：在华为云 IoTDA 上创建产品、设备、服务模型，维护设备 ID、密钥与项目 ID 等信息。  
（2）数据模型：定义 `Aquarium` 属性服务和 `aquarium_control`、`aquarium_threshold` 两个命令服务；以云端当前模型为准，并在接口文档中明确字段差异（如 `feed`/`feed_once_delay`）。  
（3）数据转发：接收设备上报的属性数据，支持控制台查看实时数值与历史趋势；将移动端或其他系统下发的命令转发到 MQTT。  
（4）鉴权与可控调用：通过 AK/SK 签名调用 REST 接口，监控设备在线状态，为后续运行维护留出扩展空间（课设演示版参数采用固定内置值）。

4.3 应用侧功能  
（1）实时监测：鸿蒙应用（HarmonyOS SDK 5.0.5，API Level 17）订阅 MQTT 属性，构建仪表盘、折线图和告警提示，实现多指标同步展示。  
（2）手动控制：提供开关按钮、滑动条等控件，支持切换自动/手动模式、控制加热与泵、执行即时投喂、静音告警、设置目标温度。  
（3）系统设置：允许用户批量更新温度、水质、水位阈值，调整自动投喂周期与档位，修改 Wi-Fi 凭据和传感器校准系数。  
（4）反馈提示：在命令执行成功或失败时给出 Toast/通知提示；断网或 MQTT 断开时展示错误状态与重试入口。  
（5）演示配置约定：应用内置固定 `Base URL / Project ID / Device ID / AK / SK / Device Secret`，运行时执行 REST 签名并提供稳定演示链路。  
（6）多端适配与服务卡片：按照 Stage 模型约定适配竖屏/横屏窗口，输出桌面服务卡片与通知中心卡片，支持 HarmonyOS 手机和平板之间的分布式流转与账号同步。  

五、系统架构设计  
系统采用典型的物联网三层架构。底层设备通过 UART 与 ESP32 交互，再由 ESP32 连接至华为云；云端 IoTDA 承担设备注册、通信转发与数据存储；上层鸿蒙应用（HarmonyOS SDK 5.0.5，API Level 17）通过 MQTT/REST 与 IoTDA 通信。数据流自下而上实现实时监测，自上而下支持命令下发。为了保证闭环运行，固件在 30 秒周期内持续上报属性，云端将最新状态广播给所有订阅终端；移动端修改阈值后经 IoTDA 转发，设备解析并写入配置后返回执行结果。

六、非功能需求  
1. 稳定性：设备需在长时间运行中保持稳定，出现网络波动时自动重连，出现传感器故障时不导致系统崩溃。  
2. 易用性：提供直观的 AP 配网页面与移动端 UI，引导用户无需专业背景即可完成部署。  
3. 文档化：输出 README、技术说明、PRD、接线指南、IoTDA 参数表等完整文档，为毕业论文和后续维护提供依据。  
4. 可扩展性：系统设计应允许未来增加传感器或接入多台设备，只需在 IoTDA 和移动端添加新字段即可复用现有框架。

七、实施计划  
阶段一（第 1–2 周）：明确硬件选型，完成原理设计与接线测试，建立基本的传感器采集与执行器驱动。  
阶段二（第 3–4 周）：实现自动控制与告警逻辑，接入 ESP32 AT 网络模块，完成 MQTT 与 AP 配网功能。  
阶段三（第 5–6 周）：搭建华为云 IoTDA 产品及数据模型，实现属性上报、命令下发、阈值配置闭环。  
阶段四（第 7–8 周）：开发鸿蒙应用（HarmonyOS SDK 5.0.5，API Level 17），完成仪表盘、控制、设置页面，打通 REST + MQTT 通路，并在 DevEco Studio 中集成必要的 HMS Core/MQTT 依赖。  
阶段五（第 9–10 周）：联调与压力测试，编写技术文档、需求文档和接线指南，准备答辩材料并录制演示视频。

八、验收标准  
1. 设备端在开启 12 小时连续运行期间，传感器采集和告警逻辑应保持正常，无异常复位。  
2. 在 IoTDA 控制台实时可见全部属性字段，命令执行有响应记录；移动端界面收到数据后 1 秒内刷新。  
3. 通过移动端修改阈值或 Wi-Fi 信息，设备 30 秒内完成配置更新并重新上线。  
4. AP 配网流程可在 5 分钟内完成，用户在成功保存配置后设备自动重启并连接新网络。  
5. `README.MD`、`docs/TECH.MD`、`docs/PRD.MD`、`docs/Wiring_Guide.md`、`docs/HuaweiCloud.MD`、`docs/Interface.MD` 六份文档完整准确，与最终代码实现一致。  
6. 答辩展示中能够演示“实时上报 → 云端查看 → 移动端控制 → 设备执行并上报结果”的闭环过程。

九、风险评估与应对  
1. 传感器精度不达标：通过校准系数在线调整，并在接线指南中提醒供电与接地注意事项。  
2. Wi-Fi 信号不稳定：通过指数退避与自动复位机制保证重连，并提供 AP 模式供临时配置。  
3. 云服务参数遗漏：在 `docs/HuaweiCloud.MD` 中维护详细清单，部署前逐项核对。  
4. 移动端权限与兼容性：应用定位于 HarmonyOS 5.0.5（API Level 17）及以上设备，使用 ArkTS + MVVM 架构减少兼容性问题，并在 DevEco Studio + Stage 模型中统一实现分布式权限申请与 REST 调用重试机制。  
5. 文档偏差：项目收尾阶段安排专门时间对照代码与云端配置，统一更新所有文档。

十、总结  
该项目旨在把物联网技术应用于复杂但常见的家庭水族管理场景，帮助学生掌握嵌入式开发、云平台建模和移动端交互的整套流程。通过上述需求定义与计划安排，项目团队可以有序推进硬件实现、固件开发、云平台配置和应用开发，并在最终答辩中展示一个可落地的智能水族箱解决方案。
